@model MSSnackGolFrontend.Models.PedidosViewModel
@{
    ViewData["Title"] = "Mis Pedidos";
    var hasOrders = Model.Orders?.Any() == true;
    var activeOrders = Model.Orders?.Where(o => o.IsActive).ToList() ?? new List<MSSnackGolFrontend.Models.OrderSummaryViewModel>();
    var completedOrders = Model.Orders?.Where(o => !o.IsActive).ToList() ?? new List<MSSnackGolFrontend.Models.OrderSummaryViewModel>();
}

<div class="container py-4 py-lg-5">
    <div class="row justify-content-center">
        <div class="col-12 col-lg-10 col-xl-9">
            
            <!-- Header -->
            <div class="d-flex flex-column flex-sm-row align-items-sm-center justify-content-between mb-4 gap-3">
                <div>
                    <h1 class="h3 fw-bold mb-1">
                        <i class="bi bi-bag-check me-2 text-primary"></i>Mis Pedidos
                    </h1>
                    <p class="text-muted mb-0 small">Revisa el estado de tus órdenes y accede a tu código QR</p>
                </div>
                <a asp-controller="Producto" asp-action="Index" class="btn btn-primary">
                    <i class="bi bi-plus-lg me-1"></i>Nuevo pedido
                </a>
            </div>

            @if (TempData["ErrorFlash"] is string errorMsg)
            {
                <div class="alert alert-danger d-flex align-items-center mb-4" role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    @errorMsg
                </div>
            }

            @if (!hasOrders)
            {
                <!-- Estado vacío -->
                <div class="card border-0 shadow-sm">
                    <div class="card-body text-center py-5">
                        <div class="mb-4">
                            <i class="bi bi-bag-x display-1 text-muted opacity-50"></i>
                        </div>
                        <h4 class="fw-semibold mb-2">No tienes pedidos aún</h4>
                        <p class="text-muted mb-4">
                            Explora nuestro catálogo y realiza tu primer pedido.<br>
                            ¡Tu snack favorito te espera!
                        </p>
                        <a asp-controller="Producto" asp-action="Index" class="btn btn-primary btn-lg px-4">
                            <i class="bi bi-cup-hot me-2"></i>Ver catálogo
                        </a>
                    </div>
                </div>
            }
            else
            {
                <!-- Pedidos activos -->
                @if (activeOrders.Any())
                {
                    <div class="mb-4">
                        <h2 class="h5 fw-semibold mb-3 d-flex align-items-center">
                            <span class="badge bg-primary rounded-pill me-2">@activeOrders.Count</span>
                            Pedidos activos
                        </h2>
                        <div class="row g-3">
                            @foreach (var order in activeOrders)
                            {
                                <div class="col-12">
                                    <div class="card border-0 shadow-sm order-card @order.StatusClass">
                                        <div class="card-body p-3 p-md-4">
                                            <div class="row align-items-center g-3">
                                                <!-- Info principal -->
                                                <div class="col-12 col-md-6">
                                                    <div class="d-flex align-items-start gap-3">
                                                        <div class="order-icon rounded-circle d-flex align-items-center justify-content-center flex-shrink-0">
                                                            @if (order.IsReadyForPickup)
                                                            {
                                                                <i class="bi bi-bell-fill pulse-icon"></i>
                                                            }
                                                            else if (order.Status.Equals("Preparing", StringComparison.OrdinalIgnoreCase))
                                                            {
                                                                <i class="bi bi-fire"></i>
                                                            }
                                                            else
                                                            {
                                                                <i class="bi bi-receipt"></i>
                                                            }
                                                        </div>
                                                        <div>
                                                            <div class="d-flex align-items-center gap-2 mb-1">
                                                                <span class="badge rounded-pill @GetBadgeClass(order.Status)">
                                                                    @order.StatusDisplay
                                                                </span>
                                                                @if (order.IsReadyForPickup)
                                                                {
                                                                    <span class="badge bg-success rounded-pill">
                                                                        <i class="bi bi-check2 me-1"></i>¡Listo!
                                                                    </span>
                                                                }
                                                            </div>
                                                            <p class="mb-1 fw-medium">
                                                                Orden #@order.OrderId.Substring(Math.Max(0, order.OrderId.Length - 8))
                                                            </p>
                                                            <p class="text-muted small mb-0">
                                                                <i class="bi bi-clock me-1"></i>@order.OrderDate.ToString("dd MMM yyyy, HH:mm")
                                                                <span class="mx-2">•</span>
                                                                <i class="bi bi-box me-1"></i>@order.ItemCount productos
                                                            </p>
                                                            <!-- Lista de productos pedidos -->
                                                            @if (order.Items.Any())
                                                            {
                                                                <div class="mt-2 pt-2 border-top">
                                                                    <p class="text-muted small mb-1 fw-semibold">
                                                                        <i class="bi bi-list-ul me-1"></i>Productos:
                                                                    </p>
                                                                    <ul class="list-unstyled mb-0 small">
                                                                        @foreach (var item in order.Items)
                                                                        {
                                                                            <li class="d-flex justify-content-between text-muted">
                                                                                <span>
                                                                                    <span class="badge bg-secondary rounded-pill me-1">@item.Quantity</span>
                                                                                    @item.ProductName
                                                                                </span>
                                                                                <span class="fw-medium">$@item.Subtotal.ToString("N0")</span>
                                                                            </li>
                                                                        }
                                                                    </ul>
                                                                </div>
                                                            }
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Código y total -->
                                                <div class="col-6 col-md-3 text-center text-md-start">
                                                    @if (!string.IsNullOrWhiteSpace(order.PickupCode))
                                                    {
                                                        <p class="text-muted small mb-1">Código de retiro</p>
                                                        <p class="fw-bold fs-5 mb-0 text-primary font-monospace">@order.PickupCode</p>
                                                    }
                                                </div>
                                                
                                                <div class="col-6 col-md-3 text-end">
                                                    <p class="text-muted small mb-1">Total</p>
                                                    <p class="fw-bold fs-5 mb-2">$@order.Total.ToString("N0")</p>
                                                    <a asp-action="Detalle" asp-route-id="@order.OrderId" 
                                                       class="btn btn-sm @(order.IsReadyForPickup ? "btn-success" : "btn-outline-primary")">
                                                        <i class="bi bi-qr-code me-1"></i>Ver QR
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Barra de progreso del estado -->
                                        <div class="order-progress px-3 px-md-4 pb-3">
                                            <div class="progress-steps">
                                                <div class="step @(IsStepCompleted(order.Status, 1) ? "completed" : "")">
                                                    <div class="step-dot"></div>
                                                    <span class="step-label d-none d-sm-inline">Confirmado</span>
                                                </div>
                                                <div class="step-line @(IsStepCompleted(order.Status, 2) ? "completed" : "")"></div>
                                                <div class="step @(IsStepCompleted(order.Status, 2) ? "completed" : "") @(order.Status.Equals("Preparing", StringComparison.OrdinalIgnoreCase) ? "active" : "")">
                                                    <div class="step-dot"></div>
                                                    <span class="step-label d-none d-sm-inline">Preparando</span>
                                                </div>
                                                <div class="step-line @(IsStepCompleted(order.Status, 3) ? "completed" : "")"></div>
                                                <div class="step @(IsStepCompleted(order.Status, 3) ? "completed" : "") @(order.IsReadyForPickup ? "active pulse-step" : "")">
                                                    <div class="step-dot"></div>
                                                    <span class="step-label d-none d-sm-inline">Listo</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                }
                
                <!-- Pedidos completados -->
                @if (completedOrders.Any())
                {
                    <div>
                        <h2 class="h5 fw-semibold mb-3 text-muted d-flex align-items-center">
                            <i class="bi bi-check-circle me-2"></i>
                            Pedidos completados (@completedOrders.Count)
                        </h2>
                        <div class="row g-3">
                            @foreach (var order in completedOrders.Take(5))
                            {
                                <div class="col-12">
                                    <div class="card border-0 shadow-sm order-card-completed">
                                        <div class="card-body p-3">
                                            <div class="row align-items-center g-2">
                                                <div class="col">
                                                    <div class="d-flex align-items-center gap-2">
                                                        <i class="bi bi-bag-check-fill text-success"></i>
                                                        <span class="fw-medium">Orden #@order.OrderId.Substring(Math.Max(0, order.OrderId.Length - 8))</span>
                                                        <span class="badge bg-secondary rounded-pill ms-2">Entregado</span>
                                                    </div>
                                                    <p class="text-muted small mb-0 mt-1">
                                                        @order.OrderDate.ToString("dd MMM yyyy")
                                                        <span class="mx-1">•</span>
                                                        @order.ItemCount productos
                                                    </p>
                                                    <!-- Lista de productos para pedidos completados -->
                                                    @if (order.Items.Any())
                                                    {
                                                        <div class="mt-2">
                                                            <small class="text-muted">
                                                                @string.Join(", ", order.Items.Select(i => $"{i.Quantity}x {i.ProductName}"))
                                                            </small>
                                                        </div>
                                                    }
                                                </div>
                                                <div class="col-auto text-end">
                                                    <p class="fw-semibold mb-0">$@order.Total.ToString("N0")</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                            @if (completedOrders.Count > 5)
                            {
                                <div class="col-12 text-center">
                                    <p class="text-muted small">
                                        Y @(completedOrders.Count - 5) pedidos más...
                                    </p>
                                </div>
                            }
                        </div>
                    </div>
                }
            }
        </div>
    </div>
</div>

@functions {
    string GetBadgeClass(string status) => status.ToLowerInvariant() switch
    {
        "confirmed" => "bg-primary",
        "preparing" => "bg-warning text-dark",
        "readyforpickup" => "bg-success",
        "delivered" => "bg-secondary",
        _ => "bg-primary"
    };

    bool IsStepCompleted(string status, int step) => status.ToLowerInvariant() switch
    {
        "confirmed" => step <= 1,
        "preparing" => step <= 2,
        "readyforpickup" => step <= 3,
        "delivered" => true,
        _ => step <= 1
    };
}

@section Styles {
    <style>
        :root {
            --order-confirmed: #e85a24;
            --order-preparing: #b45309;
            --order-ready: #047857;
            --order-delivered: #4b5563;
        }

        .order-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border-left: 4px solid var(--order-confirmed) !important;
        }
        .order-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px -8px rgba(0,0,0,0.15) !important;
        }
        .order-card.status-preparing {
            border-left-color: var(--order-preparing) !important;
        }
        .order-card.status-ready {
            border-left-color: var(--order-ready) !important;
        }

        .order-card-completed {
            opacity: 0.85;
        }
        .order-card-completed:hover {
            opacity: 1;
        }

        .order-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--order-confirmed), #c44a1a);
            color: #fff;
            font-size: 1.25rem;
        }
        .status-preparing .order-icon {
            background: linear-gradient(135deg, var(--order-preparing), #92400e);
        }
        .status-ready .order-icon {
            background: linear-gradient(135deg, var(--order-ready), #065f46);
        }

        /* Progress steps */
        .order-progress {
            border-top: 1px solid #e5e7eb;
            padding-top: 0.75rem;
        }
        .progress-steps {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.35rem;
        }
        .step-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #d1d5db;
            transition: all 0.3s ease;
        }
        .step.completed .step-dot {
            background: var(--order-confirmed);
        }
        .step.active .step-dot {
            background: var(--order-ready);
            box-shadow: 0 0 0 4px rgba(4, 120, 87, 0.2);
        }
        .step-label {
            font-size: 0.7rem;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }
        .step.completed .step-label,
        .step.active .step-label {
            color: #111827;
            font-weight: 600;
        }
        .step-line {
            flex: 1;
            height: 2px;
            background: #d1d5db;
            margin: 0 0.5rem;
            margin-bottom: 1.2rem;
        }
        .step-line.completed {
            background: var(--order-confirmed);
        }

        .pulse-icon {
            animation: pulse-icon 1s infinite;
        }
        @@keyframes pulse-icon {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }

        .pulse-step .step-dot {
            animation: pulse-dot 1.5s infinite;
        }
        @@keyframes pulse-dot {
            0%, 100% { box-shadow: 0 0 0 4px rgba(4, 120, 87, 0.2); }
            50% { box-shadow: 0 0 0 8px rgba(4, 120, 87, 0.1); }
        }

        /* Responsive */
        @@media (max-width: 575.98px) {
            .order-icon {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }
            .step-line {
                margin-bottom: 0;
            }
        }
    </style>
}
