@model MSSnackGolFrontend.Models.CartPageViewModel
@{
    ViewData["Title"] = "Catálogo de Productos";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var co = new System.Globalization.CultureInfo("es-CO");
}

<div class="container my-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">Catálogo de Productos</h2>
        <a href="~/Carrito" class="btn btn-outline-primary">
            <i class="bi bi-cart"></i> Ver carrito
        </a>
    </div>

    <div class="row">
        @if (Model.Products?.Count > 0)
        {
            @foreach (var p in Model.Products)
            {
                <div class="col-6 col-md-6 col-lg-4 mb-3">
                    <div class="border rounded p-2 h-100 d-flex flex-column product-card">
                        <div class="product-img-wrapper rounded overflow-hidden mb-2 position-relative" style="height:200px;">
                            @{
                                var raw = p?.image_url?.Trim();
                                var placeholder = "https://via.placeholder.com/400x300?text=Sin+imagen";
                                string finalImg;
                                if (!string.IsNullOrWhiteSpace(raw))
                                {
                                    if (Uri.TryCreate(raw, UriKind.Absolute, out var abs) && (abs.Scheme == Uri.UriSchemeHttp || abs.Scheme == Uri.UriSchemeHttps))
                                    {
                                        finalImg = raw;
                                    }
                                    else if (raw.StartsWith("//"))
                                    {
                                        finalImg = "https:" + raw;
                                    }
                                    else if (raw.StartsWith("/"))
                                    {
                                        finalImg = raw;
                                    }
                                    else
                                    {
                                        finalImg = placeholder;
                                    }
                                }
                                else
                                {
                                    finalImg = placeholder;
                                }
                            }
                            <img src="@finalImg" alt="@p.name" class="w-100 h-100 object-fit-cover" loading="lazy" onerror="this.onerror=null;this.src='https://via.placeholder.com/400x300?text=Sin+imagen';" referrerpolicy="no-referrer" />
                            @if (p.stock == 0)
                            {
                                <span class="badge bg-danger position-absolute top-0 start-0 m-2 shadow-sm">Agotado</span>
                            }
                        </div>
                        <div class="flex-fill">
                            <h6 class="mb-1">@p.name</h6>
                            @if (!string.IsNullOrWhiteSpace(p?.description))
                            {
                                var clamp = p.description!.Length > 90 ? " line-clamp-2" : string.Empty;
                                <div class="text-muted small@clamp">@p.description</div>
                            }
                            <div class="d-flex justify-content-between align-items-center mt-2">
                                <div class="@(p.stock == 0 ? "text-danger" : "small text-muted")">@(p.stock == 0 ? "Agotado" : $"Stock: {p.stock}")</div>
                                <div class="fw-bold text-primary">@p.price.ToString("C0", co)</div>
                            </div>
                        </div>
                        <div class="mt-2">
                            <a asp-action="Details" asp-route-id="@p.id" class="btn btn-outline-secondary btn-sm me-2">Detalles</a>
                            <a asp-action="Edit" asp-route-id="@p.id" class="btn btn-outline-primary btn-sm me-2">Editar</a>
                            <a asp-action="Delete" asp-route-id="@p.id" class="btn btn-outline-danger btn-sm">Eliminar</a>
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="col-12 text-muted">No hay productos disponibles.</div>
        }
    </div>
    <div class="mt-4">
        <a asp-action="Create" class="btn btn-primary">Crear Nuevo Producto</a>
    </div>
</div>

@section Scripts {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .product-card {
            transition: transform .15s ease, box-shadow .15s ease;
        }
        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 0.75rem 1.5rem rgba(0,0,0,.08);
        }
        .product-img-wrapper img {
            transition: transform .2s ease;
        }
        .product-card:hover .product-img-wrapper img {
            transform: scale(1.05);
        }
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
}