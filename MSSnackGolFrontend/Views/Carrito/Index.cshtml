@model MSSnackGolFrontend.Models.CartPageViewModel
@{
    ViewData["Title"] = "Carrito de Compras";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var co = new System.Globalization.CultureInfo("es-CO");
    var qrPayload = TempData["PickupQrPayload"] as string;
    var qrImage = TempData["PickupQrImage"] as string;
    var pickupCode = TempData["PickupCode"] as string;
    var pickupStatus = TempData["PickupStatus"] as string;
    var orderId = TempData["OrderId"] as string;
}

<div class="container py-4 py-lg-5">
    @if (TempData["CartFlash"] is string flash && !string.IsNullOrWhiteSpace(flash))
    {
        <div class="alert alert-info">@flash</div>
    }
    @if (!string.IsNullOrEmpty(qrPayload))
    {
        <div class="card border-success shadow-sm mb-4" data-pickup-card>
            <div class="card-body d-flex flex-column flex-lg-row align-items-lg-center gap-4">
                <div class="flex-grow-1">
                    <span class="pill mb-2 d-inline-flex align-items-center gap-2"><i class="bi bi-qr-code-scan"></i> QR de entrega</span>
                    @if (!string.IsNullOrWhiteSpace(pickupStatus))
                    {
                        <div class="badge rounded-pill bg-primary-subtle text-primary fw-semibold mb-2">@pickupStatus</div>
                    }
                    <h4 class="fw-semibold mb-2">Presenta este código para reclamar tu pedido</h4>
                    <p class="text-muted mb-1">Código de recogida: <span class="fw-semibold text-primary" data-pickup-code>@pickupCode</span></p>
                    @if (!string.IsNullOrWhiteSpace(orderId))
                    {
                        <p class="text-muted small mb-0">Orden: <span class="fw-semibold">@orderId</span></p>
                    }
                    <p class="text-muted small mb-0">Guarda una captura o muestra el QR desde tu dispositivo al llegar al punto SnackGol.</p>
                </div>
                <div class="text-center">
                    @if (!string.IsNullOrWhiteSpace(qrImage))
                    {
                        <img src="data:image/png;base64,@qrImage" alt="Código QR de entrega" class="bg-white p-3 rounded-3 shadow-sm d-inline-block" loading="lazy" decoding="async" />
                    }
                    else
                    {
                        <div id="pickup-qr" class="bg-white p-3 rounded-3 shadow-sm d-inline-block"></div>
                    }
                    <div class="small text-muted mt-2">Escanéalo con el personal autorizado</div>
                </div>
            </div>
            @if (!string.IsNullOrWhiteSpace(qrPayload))
            {
                <input type="hidden" id="pickup-qr-data" value="@qrPayload" />
            }
        </div>
    }
    <!-- Encabezado del carrito -->
    <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center mb-4 gap-3">
        <div>
            <span class="pill mb-2"><i class="bi bi-bag"></i> Carrito activo</span>
            <h2 class="section-title mb-0">Tu Carrito de Compras</h2>
            <p class="text-muted mb-0">Gestiona cantidades, elimina productos o finaliza el pedido cuando estés listo.</p>
        </div>
        <div class="d-flex gap-2">
            <a href="~/Producto" class="btn btn-outline-dark">
                <i class="bi bi-shop me-2"></i>Explorar catálogo
            </a>
            <a href="~/" class="btn btn-outline-primary">
                <i class="bi bi-arrow-left"></i> Seguir comprando
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <!-- Catálogo de productos -->
            <div class="card shadow-sm mb-4 border-0">
                <div class="card-header bg-light border-0 py-3 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Productos</h5>
                    <form asp-action="SampleData" method="post" class="m-0">
                        <button class="btn btn-sm btn-outline-secondary" title="Agrega algunos productos al carrito (solo desarrollo)">
                            Cargar datos de muestra
                        </button>
                    </form>
                </div>
                <div class="card-body">
                    @if (Model.Products?.Count > 0)
                    {
                        <div class="row">
                            @foreach (var p in Model.Products)
                            {
                                if (p is null)
                                {
                                    continue;
                                }
                                <div class="col-6 col-md-6 col-lg-4 mb-3">
                                    <div class="border rounded p-2 h-100 d-flex flex-column product-card">
                                        <div class="product-img-wrapper mb-2 position-relative">
                                            @{ 
                                                var raw = p?.image_url?.Trim();
                                                var placeholder = "https://via.placeholder.com/400x300?text=Sin+imagen";

                                                string finalImg;
                                                if (!string.IsNullOrWhiteSpace(raw))
                                                {
                                                    // absoluto http/https
                                                    if (Uri.TryCreate(raw, UriKind.Absolute, out var abs) && (abs.Scheme == Uri.UriSchemeHttp || abs.Scheme == Uri.UriSchemeHttps))
                                                    {
                                                        finalImg = raw;
                                                    }
                                                    // esquema relativo //host/path
                                                    else if (raw.StartsWith("//"))
                                                    {
                                                        finalImg = "https:" + raw;
                                                    }
                                                    // relativo a origen actual (p.ej. /imgs/..)
                                                    else if (raw.StartsWith("/"))
                                                    {
                                                        finalImg = raw;
                                                    }
                                                    else
                                                    {
                                                        finalImg = placeholder;
                                                    }
                                                }
                                                else
                                                {
                                                    finalImg = placeholder;
                                                }
                                            }
                                            <img src="@finalImg" alt="@(p?.name ?? "Producto")" class="w-100 h-100 object-fit-cover" loading="lazy" onerror="this.onerror=null;this.src='https://via.placeholder.com/400x300?text=Sin+imagen';" referrerpolicy="no-referrer" />
                                            @if ((p?.stock ?? 0) == 0)
                                            {
                                                <span class="badge bg-danger badge-floating">Agotado</span>
                                            }
                                        </div>
                                        <div class="flex-fill">
                                            <h6 class="mb-1 fw-semibold">@(p?.name ?? "Producto sin nombre")</h6>
                                            @if (!string.IsNullOrWhiteSpace(p?.description))
                                            {
                                                var clamp = p.description!.Length > 90 ? " line-clamp-2" : string.Empty;
                                                <div class="text-muted small@clamp">@p.description</div>
                                            }
                                            <div class="d-flex justify-content-between align-items-center mt-2">
                                                <div class="@((p?.stock ?? 0) == 0 ? "text-danger" : "small text-muted")">@((p?.stock ?? 0) == 0 ? "Agotado" : $"Stock: {p!.stock}")</div>
                                                <div class="fw-bold text-primary">@(p?.price.ToString("C0", co) ?? "N/A")</div>
                                            </div>
                                        </div>
                                        <form asp-action="AddItem" method="post" class="mt-2 d-flex gap-2 align-items-center">
                                            <input type="hidden" name="productId" value="@p!.id" />
                                            <input type="number" name="quantity" value="1" min="1" max="@(p?.stock ?? 1)" class="form-control form-control-sm" style="width:80px;" />
                                            <button class="btn btn-primary btn-sm" @((p?.stock ?? 0) == 0 ? "disabled" : null)>Añadir</button>
                                        </form>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="text-muted">No hay productos disponibles.</div>
                    }
                </div>
            </div>

            <!-- Carrito actual -->
            <div class="card shadow-sm mb-4 border-0">
                <div class="card-header bg-light border-0 py-3">
                    <h5 class="mb-0">Tu carrito (@(Model.Cart?.count ?? 0) artículos)</h5>
                </div>
                <div class="card-body p-0">
                    @if (Model.Cart?.items != null && Model.Cart.items.Count > 0)
                    {
                        @foreach (var item in Model.Cart.items)
                        {
                            <div class="cart-item rounded-3 p-3 mb-2 bg-body-tertiary d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center">
                                <div class="me-3">
                                    <h6 class="mb-1">@item.name</h6>
                                    <small class="text-muted">@item.unit_price.ToString("C0", co) x @item.quantity</small>
                                </div>
                                <div class="d-flex align-items-center gap-2 mt-3 mt-sm-0">
                                    <form asp-action="UpdateItem" method="post" class="d-flex align-items-center gap-2">
                                        <input type="hidden" name="id" value="@item.id" />
                                        <input type="number" name="quantity" min="0" value="@item.quantity" class="form-control form-control-sm" style="width: 70px;" />
                                        <button class="btn btn-outline-secondary btn-icon-sm" title="Actualizar cantidad" aria-label="Actualizar">
                                            <i class="bi bi-arrow-repeat"></i>
                                        </button>
                                    </form>
                                    <div class="text-end fw-bold text-primary me-1" style="min-width: 110px;">@item.subtotal.ToString("C0", co)</div>
                                    <form asp-action="DeleteItem" method="post">
                                        <input type="hidden" name="id" value="@item.id" />
                                        <button class="btn btn-outline-danger btn-icon-sm" title="Eliminar" aria-label="Eliminar">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="p-3 text-muted">Tu carrito está vacío.</div>
                    }
                </div>
            </div>
        </div>

        <!-- Resumen de compra -->
        <div class="col-lg-4">
            <div class="card shadow summary-sticky sticky-top rounded-3" style="top: 20px;">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Resumen del Pedido</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Subtotal (@(Model.Cart?.count ?? 0) productos):</span>
                        <span>@((Model.Cart?.total ?? 0).ToString("C0", co))</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Envío:</span>
                        <span class="text-success">Gratis</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="fw-semibold">Total:</span>
                        <span class="fs-3"><span class="badge bg-primary-subtle text-primary border">@((Model.Cart?.total ?? 0).ToString("C0", co))</span></span>
                    </div>

                    <div class="text-muted small mb-2">Moneda: COP</div>

                    <form asp-action="ProcederPago" method="post" class="d-grid gap-2">
                        <button class="btn btn-dark btn-lg" @(Model.Cart?.items == null || Model.Cart.items.Count == 0 ? "disabled" : null)>Proceder con el Pago</button>
                        <a href="~/" class="btn btn-outline-secondary">Continuar comprando</a>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- Barra de checkout móvil fija -->
    <div class="d-lg-none mobile-checkout-bar fixed-bottom bg-white border-top shadow-sm p-3">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="small text-muted">Total</div>
                    <div class="fw-bold">@((Model.Cart?.total ?? 0).ToString("C0", co))</div>
                </div>
                <form asp-action="ProcederPago" method="post">
                    <button class="btn btn-dark" @(Model.Cart?.items == null || Model.Cart.items.Count == 0 ? "disabled" : null)>Pagar</button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @if (string.IsNullOrWhiteSpace(qrImage) && !string.IsNullOrEmpty(qrPayload))
    {
        <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.0/build/qrcode.min.js"></script>
        <script>
            document.addEventListener("DOMContentLoaded", () => {
                const dataInput = document.getElementById("pickup-qr-data");
                const qrContainer = document.getElementById("pickup-qr");
                const codeLabel = document.querySelector("[data-pickup-code]");

                if (!dataInput || !qrContainer || !window.QRCode) {
                    return;
                }

                try {
                    const decoded = atob(dataInput.value);
                    const parsed = JSON.parse(decoded);

                    if (parsed?.code && codeLabel) {
                        codeLabel.textContent = parsed.code;
                    }

                    const canvas = document.createElement("canvas");
                    QRCode.toCanvas(canvas, decoded, { width: 180, errorCorrectionLevel: "M", margin: 1 }, (error) => {
                        if (error) {
                            console.error("No se pudo generar el código QR", error);
                            return;
                        }
                        qrContainer.innerHTML = "";
                        qrContainer.appendChild(canvas);
                    });
                } catch (error) {
                    console.error("No se pudo preparar el QR de entrega", error);
                }
            });
        </script>
    }
}