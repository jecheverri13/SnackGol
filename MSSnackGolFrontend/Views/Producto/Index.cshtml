@using System.Collections.Generic
@using System.Linq
@model MSSnackGolFrontend.Models.CartPageViewModel
@{
    ViewData["Title"] = "Catálogo de Productos";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var co = new System.Globalization.CultureInfo("es-CO");
    var categories = Model.Products?.Select(p => p.category_id).Distinct().OrderBy(id => id).ToList() ?? new List<int>();
    var categoryLabels = new Dictionary<int, string>
    {
        { 1, "Bebidas" },
        { 2, "Snacks" },
        { 3, "Dulces" },
        { 4, "Promociones" },
        { 5, "Merchandising" }
    };
    bool isAdmin = User?.Identity?.IsAuthenticated == true && (User?.IsInRole("Admin") ?? false);
    bool isClient = User?.Identity?.IsAuthenticated == true && !isAdmin;
    string? flash = TempData["CatalogFlash"] as string;
    string heroPill = isAdmin ? "Panel de inventario" : "Catálogo disponible";
    string heroDescription = isAdmin
        ? "Gestiona el inventario, edita tus productos y controla el stock visible para los clientes."
        : "Explora los snacks disponibles y añade tus favoritos al carrito en segundos.";
}

<div class="container py-4 py-lg-5">
    @if (!string.IsNullOrWhiteSpace(flash))
    {
        <div class="alert alert-info d-flex align-items-center gap-2">
            <i class="bi bi-info-circle"></i>
            <span>@flash</span>
        </div>
    }

    <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3 mb-4">
        <div>
            <span class="pill mb-2"><i class="bi bi-box"></i> @heroPill</span>
            <h2 class="section-title mb-1">Catálogo de productos</h2>
            <p class="text-muted mb-0">@heroDescription</p>
        </div>
        @if (isAdmin)
        {
            <a asp-action="Create" class="btn btn-primary btn-lg"><i class="bi bi-plus-circle me-2"></i>Nuevo producto</a>
        }
    </div>

    <div class="catalog-toolbar position-relative">
        <div class="row g-3 align-items-center">
            <div class="col-md-6">
                <div class="position-relative">
                    <i class="bi bi-search search-icon"></i>
                    <input class="form-control" type="search" placeholder="Buscar por nombre o descripción" autocomplete="off" data-filter-search />
                </div>
            </div>
            <div class="col-md-3">
                <select class="form-select" data-filter-category>
                    <option value="all">Todas las categorías</option>
                    @foreach (var categoryId in categories)
                    {
                        var label = categoryLabels.TryGetValue(categoryId, out var text) ? text : $"Categoría {categoryId}";
                        <option value="@categoryId">@label</option>
                    }
                </select>
            </div>
            <div class="col-md-3 text-md-end">
                <span class="text-muted small">Mostrando <span class="fw-semibold" data-results-count>@(Model.Products?.Count ?? 0)</span> productos</span>
            </div>
        </div>
    </div>

    @if (Model.Products?.Count > 0)
    {
        @if (isAdmin)
        {
            <div class="card card-soft p-3 p-lg-4 mb-4 shadow-sm">
                <div class="d-flex flex-column flex-lg-row justify-content-between gap-2 mb-3">
                    <div>
                        <span class="pill mb-2"><i class="bi bi-clipboard-data"></i> Inventario en vivo</span>
                        <h4 class="mb-0">Resumen rápido para administradores</h4>
                        <small class="text-muted">Solo tú ves este bloque. Usa la tabla para saltar a ediciones o limpiezas rápidas.</small>
                    </div>
                    <div class="d-flex flex-wrap gap-2">
                        <a asp-action="Create" class="btn btn-primary"><i class="bi bi-plus-lg me-1"></i>Nuevo</a>
                        <a asp-controller="AdminPedidos" asp-action="Index" class="btn btn-outline-secondary"><i class="bi bi-shield-check me-1"></i>Pedidos</a>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table align-middle mb-0">
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Precio</th>
                                <th>Stock</th>
                                <th>Estado</th>
                                <th class="text-end">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var p in Model.Products)
                            {
                                if (p is null)
                                {
                                    continue;
                                }
                                <tr>
                                    <td>
                                        <div class="fw-semibold">@p.name</div>
                                        <div class="text-muted small text-truncate" style="max-width:280px;">@p.description</div>
                                    </td>
                                    <td>@p.price.ToString("C0", co)</td>
                                    <td>
                                        <span class="badge @(p.stock == 0 ? "bg-danger" : "bg-success")">@(p.stock == 0 ? "Agotado" : p.stock + " uds")</span>
                                    </td>
                                    <td>@(p.is_active ? "Activo" : "Inactivo")</td>
                                    <td class="text-end">
                                        <div class="btn-group" role="group">
                                            <a asp-action="Edit" asp-route-id="@p.id" class="btn btn-sm btn-outline-primary"><i class="bi bi-pencil"></i></a>
                                            <a asp-action="Delete" asp-route-id="@p.id" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></a>
                                            <a asp-action="Details" asp-route-id="@p.id" class="btn btn-sm btn-outline-secondary" title="Vista cliente"><i class="bi bi-eye"></i></a>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }

        <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-4" data-product-list>
            @foreach (var p in Model.Products)
            {
                if (p is null)
                {
                    continue;
                }
                var raw = p.image_url?.Trim();
                var placeholder = "https://via.placeholder.com/600x420?text=SnackGol";
                var finalImg = placeholder;
                if (!string.IsNullOrWhiteSpace(raw))
                {
                    if (Uri.TryCreate(raw, UriKind.Absolute, out var abs) && (abs.Scheme == Uri.UriSchemeHttp || abs.Scheme == Uri.UriSchemeHttps))
                    {
                        finalImg = raw;
                    }
                    else if (raw.StartsWith("//", StringComparison.Ordinal))
                    {
                        finalImg = "https:" + raw;
                    }
                    else if (raw.StartsWith("/", StringComparison.Ordinal))
                    {
                        finalImg = raw;
                    }
                }
                var categoryLabel = categoryLabels.TryGetValue(p.category_id, out var label) ? label : $"Categoría {p.category_id}";
                var cardClasses = p.stock == 0 ? "badge-soft-danger" : "badge-soft-success";
                <div class="col" data-product-card data-product-name="@p.name" data-product-description="@p.description" data-product-category="@p.category_id">
                    <div class="product-card">
                        <div class="product-img-wrapper mb-3">
                            <img src="@finalImg" alt="@p.name" loading="lazy" onerror="this.onerror=null;this.src='https://via.placeholder.com/600x420?text=SnackGol';" referrerpolicy="no-referrer" />
                            <span class="badge bg-dark-subtle text-dark badge-floating">@categoryLabel</span>
                            @if (p.stock == 0)
                            {
                                <span class="badge bg-danger badge-floating" style="right:1rem; left:auto;">Agotado</span>
                            }
                        </div>
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h5 class="fw-semibold mb-0">@p.name</h5>
                            <span class="badge @cardClasses">@p.price.ToString("C0", co)</span>
                        </div>
                        @if (!string.IsNullOrWhiteSpace(p?.description))
                        {
                            <p class="product-meta line-clamp-2 mb-2">@(p?.description ?? string.Empty)</p>
                        }
                        <div class="product-meta mb-3">
                            <i class="bi bi-box-seam me-1"></i>
                            @((p?.stock ?? 0) == 0 ? "No disponible" : $"Stock: {p!.stock}")
                        </div>
                        <div class="d-flex flex-column gap-2 mt-auto">
                            @if (isClient)
                            {
                                if ((p?.stock ?? 0) > 0)
                                {
                                    var maxQty = Math.Max(p!.stock, 1);
                                    <form asp-controller="Carrito" asp-action="AddItem" method="post" class="d-flex gap-2 align-items-center">
                                        <input type="hidden" name="productId" value="@p!.id" />
                                        <input type="number" name="quantity" value="1" min="1" max="@maxQty" class="form-control form-control-sm" style="width: 80px;" />
                                        <button class="btn btn-primary btn-sm flex-grow-1">
                                            <i class="bi bi-bag-plus me-1"></i>Añadir al carrito
                                        </button>
                                    </form>
                                }
                                else
                                {
                                    <button class="btn btn-secondary btn-sm w-100" disabled>
                                        <i class="bi bi-slash-circle me-1"></i>Agotado temporalmente
                                    </button>
                                }
                            }
                            else if (isAdmin)
                            {
                                <div class="alert alert-light border small mb-0">
                                    Vista previa para admin: los clientes verán aquí el botón de compra.
                                </div>
                            }
                            <div class="d-flex flex-wrap gap-2">
                                <a asp-action="Details" asp-route-id="@p!.id" class="btn btn-outline-secondary flex-grow-1">
                                    <i class="bi bi-eye me-1"></i>Detalles
                                </a>
                                @if (isAdmin)
                                {
                                    <a asp-action="Edit" asp-route-id="@p!.id" class="btn btn-outline-primary flex-grow-1">
                                        <i class="bi bi-pencil-square me-1"></i>Editar
                                    </a>
                                    <a asp-action="Delete" asp-route-id="@p!.id" class="btn btn-outline-danger flex-grow-1">
                                        <i class="bi bi-trash me-1"></i>Eliminar
                                    </a>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
        <div class="card card-soft p-4 text-center mt-4 d-none" data-empty-state>
            <i class="bi bi-search display-6 text-muted mb-3"></i>
            <h4 class="fw-semibold">No encontramos resultados</h4>
            <p class="text-muted">Intenta con otro término de búsqueda o restablece los filtros.</p>
        </div>
        @if (isAdmin)
        {
            <div class="alert alert-light border mt-4 d-flex align-items-center gap-3">
                <i class="bi bi-info-circle text-primary fs-4"></i>
                <div class="text-muted small">Este listado refleja lo que verán los compradores en la tienda pública.</div>
            </div>
        }
    }
    else
    {
        <div class="card card-soft p-4 text-center" data-empty-state>
            <i class="bi bi-box-seam display-5 text-muted mb-3"></i>
            <h4 class="fw-semibold">El catálogo está vacío</h4>
            <p class="text-muted">@((isAdmin ? "Crea tu primer producto para empezar a recibir pedidos." : "Aún no hay productos publicados."))</p>
            @if (isAdmin)
            {
                <a asp-action="Create" class="btn btn-primary mt-2">Crear producto</a>
            }
            else
            {
                <a asp-controller="Home" asp-action="Index" class="btn btn-outline-primary mt-2">Volver al inicio</a>
            }
        </div>
    }
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const search = document.querySelector('[data-filter-search]');
            const category = document.querySelector('[data-filter-category]');
            const cards = Array.from(document.querySelectorAll('[data-product-card]'));
            const counter = document.querySelector('[data-results-count]');
            const emptyPlaceholder = document.querySelector('[data-empty-state]');

            const applyFilters = () => {
                const term = (search?.value || "").trim().toLowerCase();
                const categoryId = category?.value || "all";
                let visible = 0;

                cards.forEach(card => {
                    const name = (card.dataset.productName || "").toLowerCase();
                    const description = (card.dataset.productDescription || "").toLowerCase();
                    const cardCategory = card.dataset.productCategory || "";

                    const matchesTerm = !term || name.includes(term) || description.includes(term);
                    const matchesCategory = categoryId === "all" || cardCategory === categoryId;

                    const show = matchesTerm && matchesCategory;
                    card.classList.toggle("d-none", !show);
                    if (show) visible += 1;
                });

                if (counter) {
                    counter.textContent = visible;
                }

                if (emptyPlaceholder) {
                    emptyPlaceholder.classList.toggle("d-none", visible !== 0);
                }
            };

            search?.addEventListener("input", applyFilters);
            category?.addEventListener("change", applyFilters);
            applyFilters();
        });
    </script>
}