@model string
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Antiforgery
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container mt-4">
    <h2>Pedidos Nuevos</h2>

    @if (TempData["ErrorFlash"] != null)
    {
        <div class="alert alert-danger" role="alert">@TempData["ErrorFlash"]</div>
    }
    @if (TempData["SuccessFlash"] != null)
    {
        <div class="alert alert-success" role="alert">@TempData["SuccessFlash"]</div>
    }

    <div class="d-flex justify-content-between align-items-center mb-2">
        <form class="form-inline" method="get" action="/AdminPedidos">
            <label class="me-2">Ventana:</label>
            <select name="window" class="form-select form-select-sm me-2">
                <option value="15m">15 minutos</option>
                <option value="30m">30 minutos</option>
                <option value="60m" selected>1 hora</option>
                <option value="today">Hoy</option>
            </select>
            <button class="btn btn-sm btn-secondary" type="submit">Aplicar</button>
        </form>
        <div class="text-muted small">Auto-refresco: 1 hora</div>
    </div>

    <table id="ordersTable" class="table table-striped table-hover">
        <thead>
            <tr>
                <th>Pedido</th>
                <th>Estado</th>
                <th>Fecha</th>
                <th>√çtems</th>
                <th>Total</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            <!-- Rows will be rendered client-side from JSON model -->
        </tbody>
    </table>

    <script>
        (function(){
            try {
                var json = @Html.Raw(Model ?? "[]");
                var orders = json;
                if (typeof orders === 'string') {
                    orders = JSON.parse(orders || '[]');
                }

                function badgeClass(status) {
                    switch (status) {
                        case 'Confirmed': return 'status-confirmed badge';
                        case 'Preparing': return 'status-preparing badge';
                        case 'ReadyForPickup': return 'status-ready badge';
                        case 'Delivered': return 'status-delivered badge';
                        default: return 'badge-secondary';
                    }
                }

                function getNextOptionsHtml(status) {
                    if (!status) return '<select name="selectedNext" class="form-select form-select-sm d-inline-block me-1" style="width:auto;"><option value="">-</option></select>';
                    switch (status) {
                        case 'Confirmed':
                            return '<select name="selectedNext" class="form-select form-select-sm d-inline-block me-1" style="width:auto;"><option value="Preparing">Preparing</option></select>';
                        case 'Preparing':
                            return '<select name="selectedNext" class="form-select form-select-sm d-inline-block me-1" style="width:auto;"><option value="ReadyForPickup">Ready for pickup</option></select>';
                        case 'ReadyForPickup':
                            return '<select name="selectedNext" class="form-select form-select-sm d-inline-block me-1" style="width:auto;"><option value="Delivered">Delivered</option></select>';
                        default:
                            return '<select name="selectedNext" class="form-select form-select-sm d-inline-block me-1" style="width:auto;" disabled><option value="">-</option></select>';
                    }
                }

                var tbody = document.querySelector('#ordersTable tbody');
                orders.forEach(function(o) {
                    var orderId = o.orderId || '';
                    var shortId = orderId.length > 8 ? orderId.substring(0,8) : orderId;
                    var status = o.status || '';
                    var orderDate = o.orderDate ? new Date(o.orderDate) : null;
                    var items = o.itemsCount || 0;
                    var total = o.total || 0;

                    var tr = document.createElement('tr');
                    var selectHtml = getNextOptionsHtml(status);
                    tr.innerHTML = '\n+                        <td>' + shortId + '</td>\n+                        <td><span class="' + badgeClass(status) + '">' + status + '</span></td>\n+                        <td>' + (orderDate ? orderDate.toLocaleString() : '-') + '</td>\n+                        <td>' + items + '</td>\n+                        <td>' + (total.toLocaleString(undefined, {style: 'currency', currency: 'USD'})) + '</td>\n+                        <td>\n+                            <form method="post" action="/AdminPedidos/UpdateEstado" style="display:inline-flex; align-items:center; gap:4px;">\n+                                <input name="__RequestVerificationToken" type="hidden" value="' + '@Antiforgery.GetAndStoreTokens(Context).RequestToken' + '" />\n+                                <input type="hidden" name="orderId" value="' + orderId + '" />\n+                                ' + selectHtml + '\n+                                <button class="btn btn-sm btn-primary" ' + (status === 'Delivered' ? 'disabled' : '') + '>Cambiar estado</button>\n+                            </form>\n+                        </td>';
                    tbody.appendChild(tr);
                });
            } catch (ex) {
                console.error('Error rendering orders table', ex);
            }
            // Auto-refresh cada 1 hora (3600000 ms)
            setInterval(function(){
                try { window.location.reload(); } catch(e) { console.error(e); }
            }, 3600000);
        })();
    </script>
</div>
